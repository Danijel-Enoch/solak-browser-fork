<html>
<head>
	<link href="css/materialIconsRound.css" rel="stylesheet">
	<link href="css/chrome-tabs.css" rel="stylesheet">
	<!--	<link href="css/chrome-tabs-dark-theme.css" rel="stylesheet"> -->
	<link href="css/tabs.css" rel="stylesheet">
	<script>
		window.nodeRequire = require;
		delete window.require;
		delete window.exports;
		delete window.module;
	</script>
	<script>
		const { ipcRenderer } = nodeRequire('electron');
		let URLInput = null;
		let TabsDiv = null;
		let el = null;
		let chromeTabs = null;
		let selectedTab = -1;
		let waitingID = null;

		let actualURL = '';

		/*ipcRenderer.on('updateTitle', tabId, newTitle)
		{
			tabs[tabId] = newTitle;
			let obj = document.getElementById('tab' + tabId)
			//obj.innerHTML = newTitle
		}*/

		ipcRenderer.on('setSelectedTab', (event, tabId) => {
			selectedTab = tabId;
			if (document.getElementById(tabId) != null) { chromeTabs.setCurrentTab(document.getElementById(tabId)) }
		})

		ipcRenderer.on('newURL', (event, tabId, newURL) => {
			if (selectedTab == tabId) {
				document.getElementById('URLInput').value = newURL;
			}
		})

		ipcRenderer.on("refresh", (event) => { ipcRenderer.send("refresh"); })

		window.addEventListener('DOMContentLoaded', (event) => {
			URLInput = document.getElementById('URLInput');
			TabsDiv = document.getElementById('tabs');

			URLInput.addEventListener("keyup", function (event) {
				if (event.keyCode === 13) // if enter
				{
					event.preventDefault();
					document.getElementById("goButton").click();
				}
			});


			el = document.querySelector('.chrome-tabs')
			chromeTabs = new ChromeTabs()

			chromeTabs.init(el)

			el.addEventListener('activeTabChange', ({ detail }) => {
				if (selectedTab != detail.tabEl.id) {
					setSelectedTab(detail.tabEl.id)
				}
			})

			el.addEventListener('tabAdd', ({ detail }) => {
				if (waitingID != null) {
					detail.tabEl.id = waitingID;
					waitingID = null;
				}
			})
			el.addEventListener('tabRemove', ({ detail }) => { closeTab(detail.tabEl.id) })

			/*document.querySelector('button[data-add-background-tab]').addEventListener('click', _ => {
			chromeTabs.addTab({
			title: 'New Tab',
			favicon: false
			}, {
			background: true
			})
			})

			document.querySelector('button[data-remove-tab]').addEventListener('click', _ => {
			chromeTabs.removeTab(chromeTabs.activeTabEl)
			})

			document.querySelector('button[data-theme-toggle]').addEventListener('click', _ => {
			if (el.classList.contains('chrome-tabs-dark-theme')) {
			document.documentElement.classList.remove('dark-theme')
			el.classList.remove('chrome-tabs-dark-theme')
			} else {
			document.documentElement.classList.add('dark-theme')
			el.classList.add('chrome-tabs-dark-theme')
			}
			})*/

			window.addEventListener('keydown', (event) => {
				if (event.ctrlKey && event.key === 't') {
					newTab()
				}
			})

			newTab()

		})

		// src: https://stackoverflow.com/questions/5717093/check-if-a-javascript-string-is-a-url
		function validURL(str) {
			var pattern = new RegExp('^(https?:\\/\\/)?' +
				'((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' +
				'((\\d{1,3}\\.){3}\\d{1,3}))' +
				'(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' +
				'(\\?[;&a-z\\d%_.~+=-]*)?' +
				'(\\#[-a-z\\d_]*)?$', 'i');
			return !!pattern.test(str);
		}

		function go() {
			let url = URLInput.value;
			if (!validURL(url)) url = `https://google.com/search?q=${encodeURIComponent(URLInput.value)}`;
			ipcRenderer.send('goURL', url);
		}
		function goBack() {
			ipcRenderer.send("goBack", selectedTab)
		}
		function goFwd() {
			ipcRenderer.send("goForward", selectedTab)
		}
		function refresh() {
			ipcRenderer.send("refresh", selectedTab)
		}
		function closeTab(id) {
			if (document.getElementById(id) != null) chromeTabs.removeTab(document.getElementById(id))
			ipcRenderer.send('closeTab', id)
		}
		/*function menu(id) {
			const coxMenu = document.createElement("div")
			coxMenu.setAttribute("class", "contextMenu")
			const close = document.createElement("button")
			close.innerHTML = "Close"
			close.setAttribute("onclick", `closeTab(${id});`)
			close.setAttribute("id", "closeTab")
			coxMenu.appendChild(close)
			document.getElementById("tabs").appendChild(coxMenu)
			return false;
		}*/
		function newTab() {
			let id = ipcRenderer.sendSync('newTab')
			//TabsDiv.innerHTML += `<div id="tab${id}-div"><button onclick="setSelectedTab(${id})" id="tab${id}-btn" oncontextmenu="menu(${id});">(New Tab)</button><button class="tab-close" onclick="closeTab(${id})" id="tab${id}-close">-</button></div>`;

			waitingID = id // We let know, so whenever tabAdd event will be fired (that means tab was created proparly) we set it ID
			chromeTabs.addTab({
				title: 'New Tab',
				favicon: false
			})

			setSelectedTab(id)
		}

		function setSelectedTab(id) {
			ipcRenderer.send('setSelectedTab', id);
		}

		function updateURL() {
			URLInput = document.getElementById('URLInput');
			if (URLInput == null) return
			let url = ipcRenderer.sendSync('getURL', selectedTab)
			if (actualURL != url) {
				actualURL = url;
				URLInput.value = url;
			}
		}
		setInterval(updateURL, 100)
	</script>
	<script src="https://unpkg.com/draggabilly@2.2.0/dist/draggabilly.pkgd.min.js"></script>
	<script src="js/chrome-tabs.js"></script>
</head>

<body>
	<!-- An actual tabs -->
	<div class="chrome-tabs">
		<div class="chrome-tabs-content"></div>
		<div class="chrome-tabs-bottom-bar"></div>
	</div>
	<!-- Navigation buttons (it's not tabs lol)-->
	<div id="tabs" class="tabs">
		<button title="Back" class="nav" onclick="goBack();"><span class="material-icons-round">
				arrow_back
			</span></button>
		<button title="Forward" class="nav" onclick="goFwd();"><span class="material-icons-round">
				arrow_forward
			</span></button>
		<button title="Refresh" class="nav" onclick="refresh();"><span class="material-icons-round" id="refresh">
				refresh
			</span></button>
		<button title="New Tab" class="plus" onclick="newTab()"><span class="material-icons-round" style="font-family: 10px;">
				add
			</span></button>
		<input style="width: 80%" this.setSelectionRange(0, this.value.length)" id="URLInput"
			placeholder="Type URL here"></input><button title="Go" id="goButton" onclick="go()"><span class="material-icons-round">
				arrow_forward
			</span></button>

	</div>
</body>

</html>